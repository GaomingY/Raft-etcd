# Raft-etcd
本项目主要介绍Raft分布式一致性协议，并且详细讲解了分布式系统的设计理念和面临的各种问题。最后，通过etcd的源码来讲解一下Raft的落地实践

# 分布式系统
若干个单机系统通过网络连接起来就是分布式系统，它本质上是一堆电脑，每个电脑都有自己独有的CPU和硬盘，然后这堆电脑通过网络连接起来，互相之间可以通信。
(当然，现在的存算分离技术将计算资源和存储资源分离开了，也就是说有些电脑只负责计算，没有硬盘存储数据，有些电脑只负责存储数据，不具备计算数据的能力)

在之后的讲解中，我将电脑这个概念抽象成节点。
分布式系统又可以分成横向分布式系统和纵向分布式系统。分布式系统相较于单机系统最大的两个优势就是数据备份和负载均衡，这两个特点支撑了分布式系统提供规模更大，质量更高的数据服务

横向分布式系统不对单个节点性能做过多的提升，它旨在通过增多系统中节点的数量来提高系统的性能
纵向分布式系统也叫微服务架构，它主要是纵向将每个节点需要提供的服务进一步切分，比如将完整服务切分成用户模块，支付模块等等，通过提高单机性能来提高整体的性能
本项目的主角——Raft，主要就是为了解决横向分布式的一系列问题，当节点的数量不断增多，如何保证节点之间的秩序，保证在不同节点之间重复备份的数据的一致性，这就是它要考虑的问题

# CAP理论
C指的是consistency，一致性；A指的是availability，可用性；P指的是Partition tolerance，分区容错性
一致性是指数据一定是正确的，同一个数据的不同备份应该是相同的，这样用户在读数据时才不会读到错误的数据，或是过时的数据
可用性指的是分布式系统服务的高质量，分布式系统应该为client提供快速响应的数据和计算服务
分区容错性指的是在分布式系统中某些节点崩溃时，整个系统仍然能够继续运行

在一个分布式系统中，无法同时满足三者，最多只能同时满足两个。例如，要满足C，就需要某一个节点在接受到用户的写数据请求后，首先保证各个节点之间的数据更新到最新版本，然后才能给用户反馈数据改写已完成
这就会造成一个写操作的时延非常高。

如果要保证A，那么节点在改变本机数据后就会第一时间反馈给用户操作成功，然后才会去同步各个节点的数据。用户是用爽了，请求很快就完成了，然后就发了疯似地改数据，但系统要疲于更新各个节点中的数据，这就会出现因为网络延迟而导致的数据不一致问题。

因此，现代分布式系统主要有两个流派：CP流派和AP流派，在保证一个方面的同时尽可能满足另一个方面，而不是直接舍弃另一个方面

因此，所有的分布式一致性协议，包括Raft，它们要做的就是合理地取舍C和A，从而提高系统的整体下限

# 多数派原则
对于任何一项提议，这个提议可以是leader选举，也可以是分布式系统中的任何一项事务，只要有大于半数以上（不包括一半）的节点赞同，这个提议就可以通过并执行
因此，在设计系统时，节点数量尽量定为奇数，这样就可以提高容错，允许更多的节点因出现错误而无法投票（大多数情况，提议的反对票是因为节点投不出来票的原因）
半数通过的原则可以提高系统的可用性A，因为任何一项系统内发生的事务都不需要全员通过的严苛要求

# 一主多从，读写分离
一主多从很好理解，系统内同一时间只有一个合法leader，剩下的都是follower，leader负责集群内各项事务的决断，而follower就只负责干活，但follower遵循多数派原则，具有投票权，当多数follwer赞同时，它们甚至可以推翻leader
读写分离的意思就是读操作可以由集群内任意一个节点来提供服务，可以是leader，也可以是follower；而写操作只能由leader处理，并向follwer同步，即使follower收到了写请求也要发送给leader处理

# 状态机和预写日志
状态机就是存储数据的容器，可以是数据库，也可以是其他的存储介质，它的特点是只能保存最终状态，不负责记录中间状态，因此，只有状态机是远远不够的，因为如果出现错误了连回滚的机会都没有
因此，预写日志就出现了，它本质上是一个由日志记录组成的数组，每一次操作都对应这日志中的一条记录，而这个记录也拥有一个索引值index，但每一个term结束后，新任leader可能会使索引归零，因此，需要<term, index>二元组才能定位唯一日志记录
预写日志之所以有预写二字，是因为在真正的数据操作之前，它就被记录下来了，之后数据操作才会被真正执行

# 两阶段提交








